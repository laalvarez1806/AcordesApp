<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Biblioteca de Acordes</title>
    <link rel="manifest" href="manifest.json" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f9f9f9;
      }
      header {
        background: #3498db;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.5em;
      }
      main {
        padding: 20px;
      }
      input,
      button {
        margin: 8px 0;
        padding: 10px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #2980b9;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      a {
        text-decoration: none;
        color: #3498db;
        font-size: 1.1em;
        flex-grow: 1;
      }
      a:hover {
        text-decoration: underline;
      }
      .eliminarBtn,
      .setlistBtn {
        border: none;
        padding: 6px 10px;
        font-size: 0.8em;
        border-radius: 4px;
        cursor: pointer;
      }
      .eliminarBtn {
        background: #e74c3c;
        color: white;
      }
      .eliminarBtn:hover {
        background: #c0392b;
      }
      .setlistBtn {
        background: #2ecc71;
        color: white;
      }
      .setlistBtn:hover {
        background: #27ae60;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN DE SEGURIDAD -->
    <div id="loginScreen">
      <h2>Acceso a Biblioteca</h2>
      <input
        type="password"
        id="passwordInput"
        placeholder="Ingresa tu contrase침a"
      />
      <button onclick="login()">Entrar</button>
    </div>

    <!-- CONTENIDO DE LA APP -->
    <div id="appContent" style="display: none">
      <header>游꿪 Biblioteca de Acordes</header>
      <main>
        <input
          type="text"
          id="nombreCancion"
          placeholder="Nombre de la canci칩n"
        />
        <input type="file" id="archivoCancion" accept=".pdf,.jpg,.png" />
        <button onclick="agregarCancion()">Agregar archivo</button>

        <input type="file" id="fotoCancion" accept="image/*" capture="camera" />
        <button onclick="agregarFoto()">Tomar foto</button>

        <input type="text" id="buscador" placeholder="Buscar canci칩n..." />

        <h2>游닄 Biblioteca</h2>
        <ul id="listaCanciones"></ul>

        <h2>游꿨 Setlist</h2>
        <ul id="listaSetlist"></ul>
      </main>
    </div>

    <script>
      const PASSWORD = "MiClaveSecreta"; // c치mbiala por tu clave personal
      let db;

      // LOGIN
      function login() {
        const input = document.getElementById("passwordInput").value;
        if (input === PASSWORD) {
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("appContent").style.display = "block";
        } else {
          alert("Contrase침a incorrecta");
        }
      }

      // Abrir IndexedDB
      const request = indexedDB.open("BibliotecaAcordes", 1);
      request.onupgradeneeded = function (event) {
        db = event.target.result;
        const store = db.createObjectStore("canciones", {
          keyPath: "id",
          autoIncrement: true,
        });
        store.createIndex("nombre", "nombre", { unique: false });
      };
      request.onsuccess = function (event) {
        db = event.target.result;
        mostrarLista();
      };

      // Guardar archivo
      function guardarCancion(nombre, archivo) {
        const transaction = db.transaction(["canciones"], "readwrite");
        const store = transaction.objectStore("canciones");
        store.add({ nombre: nombre, archivo: archivo, tipo: archivo.type });
        transaction.oncomplete = () => mostrarLista();
      }

      // Mostrar lista
      function mostrarLista(filtro = "") {
        const transaction = db.transaction(["canciones"], "readonly");
        const store = transaction.objectStore("canciones");
        const request = store.openCursor();
        const lista = document.getElementById("listaCanciones");
        lista.innerHTML = "";

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            if (
              cursor.value.nombre.toLowerCase().includes(filtro.toLowerCase())
            ) {
              const li = document.createElement("li");
              const link = document.createElement("a");
              link.textContent = cursor.value.nombre;
              link.href = "#";
              link.onclick = () => mostrarArchivo(cursor.value);
              li.appendChild(link);
              lista.appendChild(li);
            }
            cursor.continue();
          }
        };
      }

      // Mostrar archivo en pesta침a nueva
      function mostrarArchivo(cancion) {
        const url = URL.createObjectURL(cancion.archivo);
        window.open(url, "_blank");
      }

      // Agregar archivo desde explorador
      function agregarCancion() {
        const nombre = document.getElementById("nombreCancion").value.trim();
        const archivoInput = document.getElementById("archivoCancion");
        if (!nombre || archivoInput.files.length === 0) {
          alert("Por favor ingresa un nombre y selecciona un archivo.");
          return;
        }
        const archivo = archivoInput.files[0];
        guardarCancion(nombre, archivo);
        document.getElementById("nombreCancion").value = "";
        archivoInput.value = "";
      }

      // Comprimir imagen antes de guardar
      function comprimirImagen(file, callback) {
        const lector = new FileReader();
        lector.onload = function (event) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const MAX_WIDTH = 800;
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
            fetch(dataUrl)
              .then((res) => res.blob())
              .then((blob) => callback(blob));
          };
          img.src = event.target.result;
        };
        lector.readAsDataURL(file);
      }

      // Agregar foto desde c치mara
      function agregarFoto() {
        const archivoInput = document.getElementById("fotoCancion");
        if (archivoInput.files.length === 0) return;
        const archivo = archivoInput.files[0];
        const nombre = prompt(
          "Ingresa el nombre de la canci칩n para esta foto:",
        );
        if (!nombre) return;

        comprimirImagen(archivo, function (blob) {
          guardarCancion(nombre, blob);
          archivoInput.value = "";
        });
      }

      // Buscador
      document.getElementById("buscador").addEventListener("input", (e) => {
        mostrarLista(e.target.value);
      });
    </script>

    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    </script>
  </body>
</html>
