<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Biblioteca de Acordes</title>
    <link rel="manifest" href="manifest.json" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f9f9f9;
      }
      header {
        background: #3498db;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.5em;
      }
      main {
        padding: 20px;
      }
      input,
      button {
        margin: 8px 0;
        padding: 10px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #2980b9;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      a {
        text-decoration: none;
        color: #3498db;
        font-size: 1.1em;
        flex-grow: 1;
      }
      a:hover {
        text-decoration: underline;
      }
      .eliminarBtn,
      .setlistBtn {
        border: none;
        padding: 6px 10px;
        font-size: 0.8em;
        border-radius: 4px;
        cursor: pointer;
      }
      .eliminarBtn {
        background: #e74c3c;
        color: white;
      }
      .eliminarBtn:hover {
        background: #c0392b;
      }
      .setlistBtn {
        background: #2ecc71;
        color: white;
      }
      .setlistBtn:hover {
        background: #27ae60;
      }
      #pantallaCompleta {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #ffffff;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
      }
      #pantallaCompleta iframe,
      #pantallaCompleta img {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        border: none;
      }
      #volverBtn,
      #prevBtn,
      #nextBtn {
        position: absolute;
        top: 10px;
        padding: 10px 15px;
        background: #3498db;
        color: #fff;
        border: none;
        font-size: 1em;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10000;
      }
      #volverBtn {
        left: 10px;
        background: #e74c3c;
      }
      #prevBtn {
        left: 120px;
      }
      #nextBtn {
        left: 220px;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN DE SEGURIDAD -->
    <div id="loginScreen">
      <h2>Acceso a Biblioteca</h2>
      <input
        type="password"
        id="passwordInput"
        placeholder="Ingresa tu contraseÃ±a"
      />
      <button onclick="login()">Entrar</button>
    </div>

    <!-- CONTENIDO DE LA APP -->
    <div id="appContent" style="display: none">
      <header>ðŸŽ¸ Biblioteca de Acordes</header>
      <main>
        <input
          type="text"
          id="nombreCancion"
          placeholder="Nombre de la canciÃ³n"
        />
        <input type="file" id="archivoCancion" accept=".pdf,.jpg,.png" />
        <button onclick="agregarCancion()">Agregar archivo</button>

        <input type="file" id="fotoCancion" accept="image/*" capture="camera" />
        <button onclick="agregarFoto()">Tomar foto</button>

        <input type="text" id="buscador" placeholder="Buscar canciÃ³n..." />

        <h2>ðŸ“š Biblioteca</h2>
        <ul id="listaCanciones"></ul>

        <h2>ðŸŽ¶ Setlist</h2>
        <ul id="listaSetlist"></ul>
      </main>

      <div id="pantallaCompleta">
        <button id="volverBtn" onclick="cerrarPantallaCompleta()">
          Volver
        </button>
        <button id="prevBtn" onclick="prevCancion()">Anterior</button>
        <button id="nextBtn" onclick="nextCancion()">Siguiente</button>
        <div id="contenido"></div>
      </div>
    </div>

    <script>
      const PASSWORD = "MiClaveSecreta"; // cÃ¡mbiala por tu clave personal
      let db;
      let currentIndex = 0;

      function login() {
        const input = document.getElementById("passwordInput").value;
        if (input === PASSWORD) {
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("appContent").style.display = "block";
        } else {
          alert("ContraseÃ±a incorrecta");
        }
      }

      const request = indexedDB.open("BibliotecaAcordes", 3);
      request.onupgradeneeded = function (event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains("canciones")) {
          db.createObjectStore("canciones", {
            keyPath: "id",
            autoIncrement: true,
          });
        }
        if (!db.objectStoreNames.contains("setlist")) {
          db.createObjectStore("setlist", {
            keyPath: "id",
            autoIncrement: true,
          });
        }
      };
      request.onsuccess = function (event) {
        db = event.target.result;
        mostrarLista();
        mostrarSetlist();
      };

      function guardarCancion(nombre, archivoBlob) {
        const transaction = db.transaction(["canciones"], "readwrite");
        const store = transaction.objectStore("canciones");
        store.add({ nombre, archivo: archivoBlob, tipo: archivoBlob.type });
        transaction.oncomplete = () => mostrarLista();
      }

      function mostrarLista(filtro = "") {
        const transaction = db.transaction(["canciones"], "readonly");
        const store = transaction.objectStore("canciones");
        const request = store.openCursor();
        const lista = document.getElementById("listaCanciones");
        lista.innerHTML = "";

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            if (
              cursor.value.nombre.toLowerCase().includes(filtro.toLowerCase())
            ) {
              const li = document.createElement("li");

              const link = document.createElement("a");
              link.textContent = cursor.value.nombre;
              link.href = "#";
              link.onclick = () => mostrarArchivo(cursor.value);

              const setlistBtn = document.createElement("button");
              setlistBtn.textContent = "âž• Setlist";
              setlistBtn.className = "setlistBtn";
              setlistBtn.onclick = () => agregarSetlist(cursor.value);

              const eliminarBtn = document.createElement("button");
              eliminarBtn.textContent = "ðŸ—‘ï¸";
              eliminarBtn.className = "eliminarBtn";
              eliminarBtn.onclick = () => eliminarCancion(cursor.value.id);

              li.appendChild(link);
              li.appendChild(setlistBtn);
              li.appendChild(eliminarBtn);
              lista.appendChild(li);
            }
            cursor.continue();
          }
        };
      }

      function mostrarArchivo(cancion) {
        const visor = document.getElementById("contenido");
        visor.innerHTML = "";
        if (cancion.tipo === "application/pdf") {
          visor.innerHTML = `<iframe src="${URL.createObjectURL(cancion.archivo)}"></iframe>`;
        } else {
          visor.innerHTML = `<img src="${URL.createObjectURL(cancion.archivo)}">`;
        }
        document.getElementById("pantallaCompleta").style.display = "flex";
      }

      function eliminarCancion(id) {
        const transaction = db.transaction(["canciones"], "readwrite");
        const store = transaction.objectStore("canciones");
        store.delete(id);
        transaction.oncomplete = () => mostrarLista();
      }

      function agregarSetlist(cancion) {
        const transaction = db.transaction(["setlist"], "readwrite");
        const store = transaction.objectStore("setlist");
        store.add({
          nombre: cancion.nombre,
          archivo: cancion.archivo,
          tipo: cancion.tipo,
        });
        transaction.oncomplete = () => mostrarSetlist();
      }

      function mostrarSetlist() {
        const transaction = db.transaction(["setlist"], "readonly");
        const store = transaction.objectStore("setlist");
        const request = store.getAll();
        const lista = document.getElementById("listaSetlist");
        lista.innerHTML = "";

        request.onsuccess = function () {
          const canciones = request.result;
          canciones.forEach((cancion, index) => {
            const li = document.createElement("li");

            const link = document.createElement("a");
            link.textContent = cancion.nombre;
            link.href = "#";
            link.onclick = () => mostrarArchivoSetlist(index);

            const quitarBtn = document.createElement("button");
            quitarBtn.textContent = "âŒ";
            quitarBtn.className = "eliminarBtn";
            quitarBtn.onclick = () => quitarSetlist(cancion.id);

            li.appendChild(link);
            li.appendChild(quitarBtn);
            lista.appendChild(li);
          });
        };
      }

      function mostrarArchivoSetlist(index) {
        currentIndex = index;
        const visor = document.getElementById("contenido");
        const transaction = db.transaction(["setlist"], "readonly");
        const store = transaction.objectStore("setlist");
        const request = store.getAll();

        request.onsuccess = function () {
          const canciones = request.result;
          const cancion = canciones[index];
          visor.innerHTML = "";
          if (cancion.tipo === "application/pdf") {
            visor.innerHTML = `<iframe src="${URL.createObjectURL(cancion.archivo)}"></iframe>`;
          } else {
            visor.innerHTML = `<img src="${URL.createObjectURL(cancion.archivo)}">`;
          }
          document.getElementById("pantallaCompleta").style.display = "flex";
        };
      }

      function prevCancion() {
        if (currentIndex > 0) {
          mostrarArchivoSetlist(currentIndex - 1);
        }
      }

      function nextCancion() {
        const transaction = db.transaction(["setlist"], "readonly");
        const store = transaction.objectStore("setlist");
        const request = store.getAll();
        request.onsuccess = function (event) {
          const canciones = event.target.result;
          if (currentIndex < canciones.length - 1) {
            mostrarArchivoSetlist(currentIndex + 1);
          }
        };
      }

      function cerrarPantallaCompleta() {
        document.getElementById("pantallaCompleta").style.display = "none";
      }

      function quitarSetlist(id) {
        const transaction = db.transaction(["setlist"], "readwrite");
        const store = transaction.objectStore("setlist");
        store.delete(id);
        transaction.oncomplete = () => mostrarSetlist();
      }

      // Buscador
      document.getElementById("buscador").addEventListener("input", (e) => {
        mostrarLista(e.target.value);
      });
    </script>

    <!-- Service Worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    </script>
  </body>
</html>
