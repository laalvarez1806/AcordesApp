<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Biblioteca de Acordes</title>
    <link rel="manifest" href="manifest.json" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f9f9f9;
      }
      header {
        background: #3498db;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 1.5em;
      }
      main {
        padding: 20px;
      }
      input,
      button {
        margin: 8px 0;
        padding: 10px;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      button {
        background: #3498db;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #2980b9;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      a {
        text-decoration: none;
        color: #3498db;
        font-size: 1.1em;
        flex-grow: 1;
      }
      a:hover {
        text-decoration: underline;
      }
      .eliminarBtn,
      .setlistBtn {
        border: none;
        padding: 6px 10px;
        font-size: 0.8em;
        border-radius: 4px;
        cursor: pointer;
      }
      .eliminarBtn {
        background: #e74c3c;
        color: white;
      }
      .eliminarBtn:hover {
        background: #c0392b;
      }
      .setlistBtn {
        background: #2ecc71;
        color: white;
      }
      .setlistBtn:hover {
        background: #27ae60;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN DE SEGURIDAD -->
    <div id="loginScreen">
      <h2>Acceso a Biblioteca</h2>
      <input
        type="password"
        id="passwordInput"
        placeholder="Ingresa tu contraseÃ±a"
      />
      <button onclick="login()">Entrar</button>
    </div>

    <!-- CONTENIDO DE LA APP (oculto hasta login) -->
    <div id="appContent" style="display: none">
      <header>ðŸŽ¸ Biblioteca de Acordes</header>
      <main>
        <!-- Subir archivos desde el explorador -->
        <input
          type="text"
          id="nombreCancion"
          placeholder="Nombre de la canciÃ³n"
        />
        <input type="file" id="archivoCancion" accept=".pdf,.jpg,.png" />
        <button onclick="agregarCancion()">Agregar archivo</button>

        <!-- Tomar foto con la cÃ¡mara -->
        <input type="file" id="fotoCancion" accept="image/*" capture="camera" />
        <button onclick="agregarFoto()">Tomar foto</button>

        <input type="text" id="buscador" placeholder="Buscar canciÃ³n..." />

        <h2>ðŸ“š Biblioteca</h2>
        <ul id="listaCanciones"></ul>

        <h2>ðŸŽ¶ Setlist (Canciones a tocar)</h2>
        <ul id="listaSetlist"></ul>
      </main>
    </div>

    <script>
      const PASSWORD = "MiClaveSecreta"; // cÃ¡mbiala por tu clave personal

      function login() {
        const input = document.getElementById("passwordInput").value;
        if (input === PASSWORD) {
          document.getElementById("loginScreen").style.display = "none";
          document.getElementById("appContent").style.display = "block";
        } else {
          alert("ContraseÃ±a incorrecta");
        }
      }

      let canciones = JSON.parse(localStorage.getItem("canciones")) || [];
      let setlist = JSON.parse(localStorage.getItem("setlist")) || [];

      function mostrarLista(filtro = "") {
        const lista = document.getElementById("listaCanciones");
        lista.innerHTML = "";
        canciones
          .filter((c) => c.nombre.toLowerCase().includes(filtro.toLowerCase()))
          .sort((a, b) => a.nombre.localeCompare(b.nombre))
          .forEach((cancion, index) => {
            const li = document.createElement("li");

            const link = document.createElement("a");
            link.textContent = cancion.nombre;
            link.href = "#";
            link.onclick = () => mostrarArchivo(index);

            const setlistBtn = document.createElement("button");
            setlistBtn.textContent = "âž• Setlist";
            setlistBtn.className = "setlistBtn";
            setlistBtn.onclick = () => agregarSetlist(index);

            const eliminarBtn = document.createElement("button");
            eliminarBtn.textContent = "ðŸ—‘ï¸";
            eliminarBtn.className = "eliminarBtn";
            eliminarBtn.onclick = () => eliminarCancion(index);

            li.appendChild(link);
            li.appendChild(setlistBtn);
            li.appendChild(eliminarBtn);
            lista.appendChild(li);
          });
        mostrarSetlist();
      }

      function mostrarSetlist() {
        const lista = document.getElementById("listaSetlist");
        lista.innerHTML = "";
        setlist.forEach((cancion, index) => {
          const li = document.createElement("li");

          const link = document.createElement("a");
          link.textContent = cancion.nombre;
          link.href = "#";
          link.onclick = () => mostrarArchivo(index);

          const quitarBtn = document.createElement("button");
          quitarBtn.textContent = "âŒ";
          quitarBtn.className = "eliminarBtn";
          quitarBtn.onclick = () => quitarSetlist(index);

          li.appendChild(link);
          li.appendChild(quitarBtn);
          lista.appendChild(li);
        });
      }

      // Abrir archivo en pestaÃ±a nueva (mÃ¡s seguro en mÃ³vil)
      function mostrarArchivo(index) {
        const cancion = canciones[index];
        window.open(cancion.url, "_blank");
      }

      function eliminarCancion(index) {
        if (confirm("Â¿Seguro que quieres eliminar esta canciÃ³n?")) {
          canciones.splice(index, 1);
          localStorage.setItem("canciones", JSON.stringify(canciones));
          mostrarLista();
        }
      }

      function agregarSetlist(index) {
        const cancion = canciones[index];
        if (!setlist.find((c) => c.nombre === cancion.nombre)) {
          setlist.push(cancion);
          localStorage.setItem("setlist", JSON.stringify(setlist));
          mostrarSetlist();
        } else {
          alert("Esta canciÃ³n ya estÃ¡ en el setlist.");
        }
      }

      function quitarSetlist(index) {
        setlist.splice(index, 1);
        localStorage.setItem("setlist", JSON.stringify(setlist));
        mostrarSetlist();
      }

      // CompresiÃ³n automÃ¡tica de fotos
      function comprimirImagen(file, callback) {
        const lector = new FileReader();
        lector.onload = function (event) {
          const img = new Image();
          img.onload = function () {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const MAX_WIDTH = 800;
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
            callback(dataUrl);
          };
          img.src = event.target.result;
        };
        lector.readAsDataURL(file);
      }

      function agregarCancion() {
        const nombre = document.getElementById("nombreCancion").value.trim();
        const archivoInput = document.getElementById("archivoCancion");
        if (!nombre || archivoInput.files.length === 0) {
          alert("Por favor ingresa un nombre y selecciona un archivo.");
          return;
        }
        const archivo = archivoInput.files[0];
        const lector = new FileReader();
        lector.onload = function (e) {
          const url = e.target.result;
          canciones.push({ nombre, url, tipo: archivo.type });
          localStorage.setItem("canciones", JSON.stringify(canciones));
          document.getElementById("nombreCancion").value = "";
          archivoInput.value = "";
          mostrarLista();
        };
        lector.readAsDataURL(archivo);
      }

      function agregarFoto() {
        const archivoInput = document.getElementById("fotoCancion");
        if (archivoInput.files.length === 0) return;
        const archivo = archivoInput.files[0];
        const nombre = prompt(
          "Ingresa el nombre de la canciÃ³n para esta foto:",
        );
        if (!nombre) return;

        // Comprimir la imagen antes de guardarla
        comprimirImagen(archivo, function (url) {
          canciones.push({ nombre, url, tipo: "image/jpeg" });
          localStorage.setItem("canciones", JSON.stringify(canciones));
          archivoInput.value = "";
          mostrarLista();
        });
      }

      document.getElementById("buscador").addEventListener("input", (e) => {
        mostrarLista(e.target.value);
      });

      mostrarLista();
    </script>

    <!-- Registro del service worker -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    </script>
  </body>
</html>
